name: Real Data Finance + IA (Adapters Smoke)

on:
  workflow_dispatch:
  schedule:
    - cron: "17 3 * * 1"

jobs:
  real-data-smoke:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -e .
          python -m pip install pytest

      - name: Run adapter tests
        run: |
          pytest -q tests/test_real_data_adapters.py

      - name: Build proxy CSVs + audit reports
        run: |
          mkdir -p _ci_out/real_data
          python tools/convert_real_data.py --input tests/fixtures/raw/ada_aggtrades_sample.csv --kind binance_aggtrades --out-csv _ci_out/real_data/finance_agg_proxies.csv
          python tools/convert_real_data.py --input tests/fixtures/raw/cat_trades_sample.csv --kind binance_trades --out-csv _ci_out/real_data/finance_trades_proxies.csv
          python tools/convert_real_data.py --input tests/fixtures/raw/borg_traces_sample.csv --kind borg_traces --out-csv _ci_out/real_data/ia_borg_proxies.csv
          python tools/convert_real_data.py --input tests/fixtures/raw/aiops_phase2_sample.csv --kind aiops_phase2 --out-csv _ci_out/real_data/ia_aiops_proxies.csv

          python tools/run_audit.py --dataset _ci_out/real_data/finance_agg_proxies.csv --name finance_agg --out-dir _ci_out/real_data/finance_agg --plotly
          python tools/run_audit.py --dataset _ci_out/real_data/ia_borg_proxies.csv --name ia_borg --out-dir _ci_out/real_data/ia_borg --plotly

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: real_data_smoke_artifacts
          path: _ci_out/real_data