name: Manual ORI-C Runs

on:
  workflow_dispatch:
    inputs:
      suite:
        description: "Which suite to run"
        required: true
        default: "all"
        type: choice
        options:
          - all
          - ori_demo
          - synthetic_demo
          - robustness
          - reinjection
          - neuro
      n_runs:
        description: "Replicates per test where applicable"
        required: false
        default: "50"
      seed:
        description: "Master seed"
        required: false
        default: "42"

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"

      - name: Install dependencies
        run: |
          set -e
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          if [ -f 04_Code/requirements.txt ]; then pip install -r 04_Code/requirements.txt; fi
          if [ -f requirements-dev.txt ]; then pip install -r requirements-dev.txt; fi
          if [ -f pyproject.toml ]; then pip install -e .; fi
          pip install "numpy>=1.26" "pandas>=2.0" "matplotlib>=3.8" "scipy>=1.11" "pytest>=8.0" "statsmodels>=0.14"

      - name: Run selected suite
        env:
          SUITE: ${{ inputs.suite }}
          N_RUNS: ${{ inputs.n_runs }}
          SEED: ${{ inputs.seed }}
        run: |
          set -e
          mkdir -p _ci_out
          echo "suite=$SUITE n_runs=$N_RUNS seed=$SEED" | tee _ci_out/selected_suite.txt

          if [ "$SUITE" = "all" ]; then
            if [ -f run_all_tests.py ]; then
              python run_all_tests.py 2>&1 | tee _ci_out/run.log
            else
              python 04_Code/pipeline/run_all_tests.py 2>&1 | tee _ci_out/run.log
            fi
          elif [ "$SUITE" = "ori_demo" ]; then
            python 04_Code/pipeline/run_ori_c_demo.py --outdir _ci_out/ori_demo --n-runs "$N_RUNS" --master-seed "$SEED" 2>&1 | tee _ci_out/run.log
          elif [ "$SUITE" = "synthetic_demo" ]; then
            INPUT="03_Data/synthetic/synthetic_with_threshold.csv"
            if [ ! -f "$INPUT" ]; then INPUT="03_Data/synthetic/synthetic_minimal.csv"; fi
            python 04_Code/pipeline/run_synthetic_demo.py --input "$INPUT" --outdir _ci_out/synthetic_demo --k 2.0 --m 3 2>&1 | tee _ci_out/run.log
          elif [ "$SUITE" = "robustness" ]; then
            INPUT="03_Data/synthetic/synthetic_with_threshold.csv"
            if [ ! -f "$INPUT" ]; then INPUT="03_Data/synthetic/synthetic_minimal.csv"; fi
            python 04_Code/pipeline/run_robustness.py --input "$INPUT" --outdir _ci_out/robustness 2>&1 | tee _ci_out/run.log
          elif [ "$SUITE" = "reinjection" ]; then
            python 04_Code/pipeline/run_reinjection_demo.py --outdir _ci_out/reinjection --n-runs "$N_RUNS" --master-seed "$SEED" 2>&1 | tee _ci_out/run.log
          elif [ "$SUITE" = "neuro" ]; then
            if [ -f 04_Code/pipeline/run_bump_attractor.py ]; then
              python 04_Code/pipeline/run_bump_attractor.py --outdir _ci_out/neuro_test9a --n-runs "$N_RUNS" --master-seed "$SEED" 2>&1 | tee _ci_out/run.log
            else
              echo "run_bump_attractor.py not found, skipping Test9A." | tee _ci_out/run.log
            fi
            if [ -f 04_Code/pipeline/run_bcm_test.py ]; then
              python 04_Code/pipeline/run_bcm_test.py --outdir _ci_out/neuro_test9b --master-seed "$SEED" 2>&1 | tee -a _ci_out/run.log
            else
              echo "run_bcm_test.py not found, skipping Test9B." | tee -a _ci_out/run.log
            fi
          fi

          if [ -d 05_Results ]; then
            cp -R 05_Results _ci_out/05_Results
          fi

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: manual_run_${{ inputs.suite }}_${{ github.run_id }}
          path: _ci_out
          if-no-files-found: warn
